generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================ ПОЛЬЗОВАТЕЛИ ================
model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique @db.VarChar(255)
  username  String   @unique @db.VarChar(50)
  password  String   @db.Char(60)
  name      String?  @db.VarChar(100)
  avatar    String?  @db.Text
  online    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Отношения
  messages         Message[]
  chatParticipants ChatParticipant[]
  refreshTokens    RefreshToken[]
  createdChats     Chat[]         @relation("ChatCreator")
  
  @@map("users")
}

// ================ ЧАТЫ ================
model Chat {
  id           String   @id @default(uuid()) @db.Uuid
  type         ChatType @default(DIRECT)
  name         String?  @db.VarChar(100)
  createdById  String   @db.Uuid
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Отношения
  creator      User              @relation("ChatCreator", fields: [createdById], references: [id], onDelete: Cascade)
  participants ChatParticipant[]
  messages     Message[]
  
  @@map("chats")
}

// Типы чатов
enum ChatType {
  DIRECT
  GROUP
}

// ================ УЧАСТНИКИ ЧАТОВ ================
model ChatParticipant {
  id        String   @id @default(uuid()) @db.Uuid
  chatId    String   @db.Uuid
  userId    String   @db.Uuid
  role      ChatRole @default(MEMBER)
  joinedAt  DateTime @default(now())
  lastSeen  DateTime? // Когда пользователь последний раз видел сообщения
  
  // Отношения
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([chatId, userId])
  @@index([userId])
  @@map("chat_participants")
}

// Роли в чате
enum ChatRole {
  CREATOR  // Создатель чата (только для групповых)
  ADMIN    // Администратор
  MEMBER   // Участник
}

// ================ СООБЩЕНИЯ ================
model Message {
  id        String   @id @default(uuid()) @db.Uuid
  content   String   @db.Text
  chatId    String   @db.Uuid
  senderId  String   @db.Uuid
  type      MessageType @default(TEXT)
  metadata  Json?  
  readBy    Json?   

  messageHash  String?   @db.Text
  isEncrypted  Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Отношения
  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([chatId, createdAt])
  @@map("messages")
}

// Типы сообщений
enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM // Системные сообщения (пользователь присоединился, вышел и т.д.)
}

// ================ REFRESH TOKENS ================
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique @db.Text  // JWT токены могут быть длинными
  userId    String   @db.Uuid
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // Отношения
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}